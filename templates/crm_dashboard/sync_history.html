{% extends 'crm_dashboard/base.html' %}
{% load static %}

{% block title %}Sync History - CRM Dashboard{% endblock %}

{% block extra_css %}
<style>
    .table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .table {
        margin-bottom: 0;
    }
    
    .table thead th {
        background: #6c757d;
        color: white;
        border: none;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        padding: 1rem;
        white-space: nowrap;
    }
    
    .table tbody td {
        border: none;
        border-bottom: 1px solid #f1f3f4;
        vertical-align: middle;
        padding: 1rem;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .status-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .status-badge.success {
        background-color: #28a745;
        color: white;
    }
    
    .status-badge.failed {
        background-color: #dc3545;
        color: white;
    }
    
    .status-badge.running {
        background-color: #007bff;
        color: white;
    }
    
    .crm-badge {
        background: #6c757d;
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .sync-type-badge {
        background: #17a2b8;
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .action-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #007bff;
        background: transparent;
        color: #007bff;
        transition: all 0.2s;
    }
    
    .action-btn:hover {
        background: #007bff;
        color: white;
    }
    
    .filters-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .breadcrumb {
        background: none;
        padding: 0;
        margin-bottom: 1.5rem;
    }
    
    .breadcrumb-item + .breadcrumb-item::before {
        content: "â€º";
        color: #6c757d;
    }
    
    /* Modal styles */
    .info-card {
        border: 1px solid #e9ecef;
    }
    
    .performance-metrics, .configuration-details {
        max-height: 200px;
        overflow-y: auto;
    }
    
    .performance-metrics .d-flex, .configuration-details .d-flex {
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    .performance-metrics .d-flex:last-child, .configuration-details .d-flex:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    #syncDetailsModal .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'ingestion:crm_dashboard:crm_dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item active" aria-current="page">Sync History</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">
                <i class="fas fa-history me-2"></i>Sync History
            </h2>
            <p class="text-muted mb-0">View and monitor all CRM synchronization activities</p>
        </div>
        <div>
            <button class="btn btn-outline-primary me-2" onclick="refreshHistory()">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
            <button class="btn btn-primary" onclick="exportHistory()">
                <i class="fas fa-download me-1"></i>Export
            </button>
        </div>
    </div>

    <!-- Filters Card -->
    <div class="filters-card">
        <div class="row align-items-end">
            <div class="col-md-3">
                <label for="crmFilter" class="form-label">CRM Source</label>
                <select class="form-select" id="crmFilter">
                    <option value="">All CRM Sources</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="modelFilter" class="form-label">Model</label>
                <select class="form-select" id="modelFilter">
                    <option value="">All Models</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="statusFilter" class="form-label">Status</label>
                <select class="form-select" id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="success">Success</option>
                    <option value="failed">Failed</option>
                    <option value="running">Running</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="dateFilter" class="form-label">Date Range</label>
                <select class="form-select" id="dateFilter">
                    <option value="">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">Last 7 days</option>
                    <option value="month">Last 30 days</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="applyFilters()">
                    <i class="fas fa-filter me-1"></i>Filter
                </button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading sync history...</p>
    </div>

    <!-- Table Container -->
    <div id="historyContainer" class="table-container" style="display: none;">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>CRM</th>
                        <th>SYNC TYPE</th>
                        <th>STATUS</th>
                        <th>STARTED</th>
                        <th>DURATION</th>
                        <th>RECORDS</th>
                        <th>ACTIONS</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="text-center py-5" style="display: none;">
        <i class="fas fa-clock fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">No Sync History</h4>
        <p class="text-muted">No synchronization activities match your current filters.</p>
    </div>
</div>

<!-- Sync Details Modal -->
<div class="modal fade" id="syncDetailsModal" tabindex="-1" aria-labelledby="syncDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="syncDetailsModalLabel">Sync Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="syncDetailsContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading sync details...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let hasMorePages = true;
let isLoading = false;

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadFilters();
    loadHistory();
});

function loadFilters() {
    // Load CRM sources for filter
    fetch('/ingestion/crm-dashboard/api/crms/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const crmFilter = document.getElementById('crmFilter');
                data.crm_sources.forEach(crm => {
                    const option = document.createElement('option');
                    option.value = crm.name;
                    option.textContent = crm.display_name || crm.name;
                    crmFilter.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Error loading CRM filters:', error));
}

function loadHistory(reset = true) {
    if (isLoading) return;
    isLoading = true;
    
    if (reset) {
        currentPage = 1;
        showLoading();
        document.getElementById('historyTableBody').innerHTML = '';
    }
    
    const params = new URLSearchParams({
        limit: 20,
        offset: (currentPage - 1) * 20,
        crm_source: document.getElementById('crmFilter').value,
        sync_type: document.getElementById('modelFilter').value,
        status: document.getElementById('statusFilter').value
    });
    
    // Only add date_range if it's supported by the API
    const dateRange = document.getElementById('dateFilter').value;
    if (dateRange && dateRange !== 'all') {
        params.set('date_range', dateRange);
    }
    
    fetch(`/ingestion/crm-dashboard/api/sync/history/?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderHistory(data.data, reset);
                hasMorePages = data.has_more;
                updateLoadMoreButton();
            } else {
                showError('Failed to load history: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error loading history:', error);
            showError('Failed to load sync history');
        })
        .finally(() => {
            hideLoading();
            isLoading = false;
        });
}

function renderHistory(historyItems, reset = true) {
    const tableBody = document.getElementById('historyTableBody');
    const container = document.getElementById('historyContainer');
    const emptyState = document.getElementById('emptyState');
    
    if (reset) {
        tableBody.innerHTML = '';
    }
    
    if (!historyItems || historyItems.length === 0) {
        if (reset) {
            container.style.display = 'none';
            emptyState.style.display = 'block';
        }
        return;
    }
    
    emptyState.style.display = 'none';
    container.style.display = 'block';
    
    historyItems.forEach(item => {
        const row = createTableRow(item);
        tableBody.appendChild(row);
    });
}

function createTableRow(item) {
    const row = document.createElement('tr');
    
    const statusClass = item.status === 'success' ? 'success' : (item.status === 'failed' ? 'failed' : 'running');
    const statusIcon = getStatusIcon(item.status);
    const duration = item.duration ? formatDuration(item.duration) : '-';
    const recordsText = item.records_processed ? formatNumber(item.records_processed) : '-';
    const timeAgo = getTimeAgo(item.start_time);
    
    row.innerHTML = `
        <td>
            <span class="crm-badge">${escapeHtml(item.crm_name || item.crm_source)}</span>
        </td>
        <td>
            <span class="sync-type-badge">${escapeHtml((item.model_name || item.sync_type).replace(/_/g, ' '))}</span>
        </td>
        <td>
            <span class="status-badge ${statusClass}">
                <i class="fas fa-${statusIcon}"></i>
                ${item.status.charAt(0).toUpperCase() + item.status.slice(1)}
            </span>
        </td>
        <td>
            <span class="text-muted">${timeAgo}</span>
        </td>
        <td>
            <strong>${duration}</strong>
        </td>
        <td>
            <strong>${recordsText}</strong>
        </td>
        <td>
            <button class="action-btn" onclick="viewSyncDetails(${item.id})" title="View Details">
                <i class="fas fa-eye"></i>
            </button>
        </td>
    `;
    
    return row;
}

// Helper functions
function getStatusIcon(status) {
    switch (status) {
        case 'success': return 'check';
        case 'failed': return 'times';
        case 'running': return 'spinner fa-spin';
        default: return 'question';
    }
}

function getTimeAgo(dateString) {
    if (!dateString) return '-';
    
    const date = new Date(dateString);
    const now = new Date();
    const diffInMinutes = Math.floor((now - date) / (1000 * 60));
    
    if (diffInMinutes < 1) return 'Just now';
    if (diffInMinutes < 60) return `${diffInMinutes} minute${diffInMinutes === 1 ? '' : 's'} ago`;
    
    const diffInHours = Math.floor(diffInMinutes / 60);
    if (diffInHours < 24) return `${diffInHours} hour${diffInHours === 1 ? '' : 's'} ago`;
    
    const diffInDays = Math.floor(diffInHours / 24);
    return `${diffInDays} day${diffInDays === 1 ? '' : 's'} ago`;
}

function formatDuration(seconds) {
    if (!seconds || seconds < 1) return '0s';
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
        return `${hours}h ${minutes}m`;
    } else if (minutes > 0) {
        return `${minutes}m ${secs}s`;
    } else {
        return `${secs}s`;
    }
}

function formatNumber(num) {
    if (!num || num === 0) return '0';
    if (num < 1000) return num.toString();
    if (num < 1000000) return `${(num/1000).toFixed(1)}K`;
    return `${(num/1000000).toFixed(1)}M`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function viewSyncDetails(syncId) {
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('syncDetailsModal'));
    modal.show();
    
    // Reset content to loading state
    document.getElementById('syncDetailsContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading sync details...</p>
        </div>
    `;
    
    // Fetch sync details
    fetch(`/ingestion/crm-dashboard/api/sync/history/${syncId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySyncDetails(data.data);
            } else {
                throw new Error(data.error || 'Failed to load sync details');
            }
        })
        .catch(error => {
            console.error('Error loading sync details:', error);
            document.getElementById('syncDetailsContent').innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Error:</strong> ${error.message}
                </div>
            `;
        });
}

function getStatusClass(status) {
    switch (status?.toLowerCase()) {
        case 'success': return 'success';
        case 'failed': return 'danger';
        case 'running': return 'warning';
        case 'pending': return 'secondary';
        default: return 'secondary';
    }
}

function getStatusIcon(status) {
    switch (status?.toLowerCase()) {
        case 'success': return 'check';
        case 'failed': return 'times';
        case 'running': return 'spinner fa-spin';
        case 'pending': return 'clock';
        default: return 'question';
    }
}

function displaySyncDetails(syncData) {
    const statusClass = getStatusClass(syncData.status);
    const statusIcon = getStatusIcon(syncData.status);
    
    const totalRecords = syncData.records_processed || 0;
    const successfulRecords = (syncData.records_created || 0) + (syncData.records_updated || 0);
    const failedRecords = syncData.records_failed || 0;
    
    let performanceHtml = '';
    if (syncData.performance_metrics && Object.keys(syncData.performance_metrics).length > 0) {
        performanceHtml = `
            <div class="col-12 mt-3">
                <h6><i class="fas fa-chart-line me-2"></i>Performance Metrics</h6>
                <div class="performance-metrics p-3" style="background: #f8f9fa; border-radius: 8px;">
                    ${Object.entries(syncData.performance_metrics).map(([key, value]) => `
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</span>
                            <span class="fw-bold">${value}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    let configurationHtml = '';
    if (syncData.configuration && Object.keys(syncData.configuration).length > 0) {
        configurationHtml = `
            <div class="col-12 mt-3">
                <h6><i class="fas fa-cog me-2"></i>Configuration</h6>
                <div class="configuration-details p-3" style="background: #f8f9fa; border-radius: 8px;">
                    ${Object.entries(syncData.configuration).map(([key, value]) => `
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</span>
                            <span class="fw-bold">${JSON.stringify(value)}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    let errorHtml = '';
    if (syncData.error_message) {
        errorHtml = `
            <div class="col-12 mt-3">
                <h6><i class="fas fa-exclamation-triangle me-2 text-danger"></i>Error Details</h6>
                <div class="alert alert-danger">
                    ${syncData.error_message}
                </div>
            </div>
        `;
    }
    
    document.getElementById('syncDetailsContent').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                <div class="info-card p-3" style="background: #f8f9fa; border-radius: 8px;">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Sync ID:</span>
                        <span class="fw-bold">#${syncData.id}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">CRM Source:</span>
                        <span class="fw-bold">${syncData.crm_source || 'N/A'}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Sync Type:</span>
                        <span class="fw-bold">${syncData.sync_type || 'N/A'}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Status:</span>
                        <span class="status-badge status-${syncData.status}">
                            <i class="fas fa-${statusIcon}"></i> ${syncData.status?.toUpperCase() || 'N/A'}
                        </span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Duration:</span>
                        <span class="fw-bold">${syncData.duration || 'N/A'}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Success Rate:</span>
                        <span class="fw-bold ${syncData.success_rate >= 90 ? 'text-success' : syncData.success_rate >= 50 ? 'text-warning' : 'text-danger'}">${syncData.success_rate}%</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-clock me-2"></i>Timing</h6>
                <div class="info-card p-3" style="background: #f8f9fa; border-radius: 8px;">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Start Time:</span>
                        <span class="fw-bold">${syncData.start_time}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">End Time:</span>
                        <span class="fw-bold">${syncData.end_time}</span>
                    </div>
                </div>
                
                <h6 class="mt-3"><i class="fas fa-database me-2"></i>Record Statistics</h6>
                <div class="info-card p-3" style="background: #f8f9fa; border-radius: 8px;">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Total Processed:</span>
                        <span class="fw-bold">${totalRecords.toLocaleString()}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Created:</span>
                        <span class="fw-bold text-success">${(syncData.records_created || 0).toLocaleString()}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Updated:</span>
                        <span class="fw-bold text-info">${(syncData.records_updated || 0).toLocaleString()}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Failed:</span>
                        <span class="fw-bold text-danger">${failedRecords.toLocaleString()}</span>
                    </div>
                </div>
            </div>
            ${configurationHtml}
            ${performanceHtml}
            ${errorHtml}
        </div>
    `;
}

function exportHistory() {
    const params = new URLSearchParams({
        crm_source: document.getElementById('crmFilter').value,
        sync_type: document.getElementById('modelFilter').value,
        status: document.getElementById('statusFilter').value,
        export: 'csv'
    });
    
    const dateRange = document.getElementById('dateFilter').value;
    if (dateRange && dateRange !== 'all') {
        params.set('date_range', dateRange);
    }
    
    window.open(`/ingestion/crm-dashboard/api/sync/history/?${params}`);
}

function showLoading() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('historyContainer').style.display = 'none';
    document.getElementById('emptyState').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

function updateLoadMoreButton() {
    const container = document.getElementById('loadMoreContainer');
    if (container) {
        container.style.display = hasMorePages ? 'block' : 'none';
    }
}

function loadMoreHistory() {
    currentPage++;
    loadHistory(false);
}

function applyFilters() {
    loadHistory(true);
}

function refreshHistory() {
    loadHistory(true);
}

function showError(message) {
    console.error('Error:', message);
    alert('Error: ' + message);
}
</script>
{% endblock %}