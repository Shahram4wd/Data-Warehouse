{% extends 'crm_dashboard/base.html' %}
{% load static %}

{% block title %}{{ model_name|title }} Detail - CRM Dashboard{% endblock %}

{% block extra_css %}
<style>
    .detail-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    .metric-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border: none;
        transition: transform 0.2s;
    }
    .metric-card:hover {
        transform: translateY(-2px);
    }
    .metric-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    .metric-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .data-table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .table-header {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        padding: 1rem 1.5rem;
    }
    .table th {
        border: none;
        font-weight: 600;
        color: #495057;
        background: #f8f9fa;
    }
    .table td {
        border: none;
        border-bottom: 1px solid #f1f3f4;
        vertical-align: middle;
    }
    .search-controls {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .breadcrumb {
        background: none;
        padding: 0;
        margin-bottom: 1.5rem;
    }
    .breadcrumb-item + .breadcrumb-item::before {
        content: "â€º";
        color: #6c757d;
    }
    .sync-status-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .pagination {
        margin-bottom: 0;
    }
    .page-link {
        border: none;
        color: #667eea;
        padding: 0.5rem 0.75rem;
    }
    .page-link:hover {
        color: #764ba2;
        background: #f8f9fa;
    }
    .page-item.active .page-link {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: transparent;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'ingestion:crm_dashboard:crm_dashboard' %}" class="text-decoration-none">
                    <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'ingestion:crm_dashboard:crm_models' crm_source %}" class="text-decoration-none">
                    {{ crm_source|title }}
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ model_name|title }}</li>
        </ol>
    </nav>

    <!-- Detail Header -->
    <div class="detail-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-2">
                    <i class="fas fa-table me-2"></i>
                    {{ model_name|title }}
                </h1>
                <p class="mb-0 opacity-75" id="modelDescription">Loading model details...</p>
            </div>
            <div class="col-md-4 text-md-end">
                <button class="btn btn-light me-2" onclick="refreshData()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <button class="btn btn-warning" onclick="showSyncModal()">
                    <i class="fas fa-play me-1"></i>Sync Now
                </button>
            </div>
        </div>
    </div>

    <!-- Metrics Row -->
    <div class="row g-4 mb-4" id="metricsContainer">
        <div class="col-xl-3 col-lg-6">
            <div class="metric-card">
                <div class="metric-number text-primary" id="totalRecords">-</div>
                <div class="metric-label">Total Records</div>
            </div>
        </div>
        <div class="col-xl-3 col-lg-6">
            <div class="metric-card">
                <div class="metric-number text-success" id="lastSyncDate">-</div>
                <div class="metric-label">Last Sync</div>
            </div>
        </div>
        <div class="col-xl-3 col-lg-6">
            <div class="metric-card">
                <div class="metric-number text-info" id="syncDuration">-</div>
                <div class="metric-label">Duration</div>
            </div>
        </div>
        <div class="col-xl-3 col-lg-6">
            <div class="metric-card">
                <div class="metric-number" id="syncStatus">-</div>
                <div class="metric-label">Status</div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="search-controls">
        <div class="row align-items-end">
            <div class="col-md-4">
                <label for="searchInput" class="form-label">Search Records</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="Search in all fields...">
                </div>
            </div>
            <div class="col-md-3">
                <label for="pageSizeSelect" class="form-label">Records per page</label>
                <select class="form-select" id="pageSizeSelect">
                    <option value="10">10 records</option>
                    <option value="25" selected>25 records</option>
                    <option value="50">50 records</option>
                    <option value="100">100 records</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="sortSelect" class="form-label">Sort by</label>
                <select class="form-select" id="sortSelect">
                    <option value="id">ID</option>
                    <option value="created_at">Created Date</option>
                    <option value="updated_at">Updated Date</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="applyFilters()">
                    <i class="fas fa-filter me-1"></i>Apply
                </button>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="card mb-4">
        <div class="card-header bg-white">
            <ul class="nav nav-tabs card-header-tabs" id="modelTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-pane" type="button" role="tab">
                        <i class="fas fa-table me-1"></i>Data Records
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule-pane" type="button" role="tab">
                        <i class="fas fa-calendar-alt me-1"></i>Scheduling
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-pane" type="button" role="tab">
                        <i class="fas fa-history me-1"></i>Sync History
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="modelTabContent">
                <!-- Data Records Tab -->
                <div class="tab-pane fade show active" id="data-pane" role="tabpanel">
                    <!-- Data Table -->
    <div class="data-table-container">
        <div class="table-header">
            <div class="row align-items-center">
                <div class="col">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Records
                        <span id="recordsInfo" class="text-muted small ms-2"></span>
                    </h5>
                </div>
                <div class="col-auto">
                    <button class="btn btn-outline-primary btn-sm" onclick="exportData()">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="tableLoading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading data...</p>
        </div>

        <!-- Table Content -->
        <div id="tableContainer" style="display: none;">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="dataTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-5" style="display: none;">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No Records Found</h4>
            <p class="text-muted">No data records match your current filters.</p>
        </div>

        <!-- Pagination -->
        <div id="paginationContainer" class="px-3 py-3 border-top" style="display: none;">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <small class="text-muted" id="paginationInfo"></small>
                </div>
                <div class="col-md-6">
                    <nav aria-label="Table pagination">
                        <ul class="pagination pagination-sm justify-content-end mb-0" id="paginationList">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
                </div>
                
                <!-- Scheduling Tab -->
                <div class="tab-pane fade" id="schedule-pane" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <h5><i class="fas fa-calendar-plus me-2"></i>Create New Schedule</h5>
                            <form id="scheduleForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ schedule_form.name.id_for_label }}" class="form-label">{{ schedule_form.name.label }}</label>
                                        {{ schedule_form.name }}
                                        <div class="form-text">{{ schedule_form.name.help_text }}</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ schedule_form.mode.id_for_label }}" class="form-label">{{ schedule_form.mode.label }}</label>
                                        {{ schedule_form.mode }}
                                        <div class="form-text">
                                            <strong>Delta:</strong> Import since last import<br>
                                            <strong>Full:</strong> Delete everything and import again<br>
                                            <strong>Force7:</strong> Import last 7 days with --force flag
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ schedule_form.recurrence_type.id_for_label }}" class="form-label">{{ schedule_form.recurrence_type.label }}</label>
                                        {{ schedule_form.recurrence_type }}
                                    </div>
                                </div>
                                
                                <!-- Interval Schedule Fields -->
                                <div id="intervalFields" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <label for="{{ schedule_form.every.id_for_label }}" class="form-label">Every</label>
                                            {{ schedule_form.every }}
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="{{ schedule_form.period.id_for_label }}" class="form-label">Period</label>
                                            {{ schedule_form.period }}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Crontab Schedule Fields -->
                                <div id="crontabFields" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-2 mb-3">
                                            <label for="{{ schedule_form.minute.id_for_label }}" class="form-label">Minute</label>
                                            {{ schedule_form.minute }}
                                        </div>
                                        <div class="col-md-2 mb-3">
                                            <label for="{{ schedule_form.hour.id_for_label }}" class="form-label">Hour</label>
                                            {{ schedule_form.hour }}
                                        </div>
                                        <div class="col-md-2 mb-3">
                                            <label for="{{ schedule_form.day_of_week.id_for_label }}" class="form-label">Day of Week</label>
                                            {{ schedule_form.day_of_week }}
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="{{ schedule_form.day_of_month.id_for_label }}" class="form-label">Day of Month</label>
                                            {{ schedule_form.day_of_month }}
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="{{ schedule_form.month_of_year.id_for_label }}" class="form-label">Month of Year</label>
                                            {{ schedule_form.month_of_year }}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ schedule_form.start_at.id_for_label }}" class="form-label">Start At</label>
                                        {{ schedule_form.start_at }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ schedule_form.end_at.id_for_label }}" class="form-label">End At</label>
                                        {{ schedule_form.end_at }}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        {{ schedule_form.enabled }}
                                        <label class="form-check-label" for="{{ schedule_form.enabled.id_for_label }}">
                                            {{ schedule_form.enabled.label }}
                                        </label>
                                    </div>
                                </div>
                                
                                {{ schedule_form.crm_source }}
                                {{ schedule_form.model_name }}
                                
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>Create Schedule
                                </button>
                            </form>
                        </div>
                        <div class="col-md-4">
                            <h5><i class="fas fa-list me-2"></i>Existing Schedules</h5>
                            <div id="existingSchedules">
                                {% for schedule in existing_schedules %}
                                <div class="card mb-2">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="card-title mb-1">{{ schedule.name }}</h6>
                                                <small class="text-muted">{{ schedule.get_mode_display }}</small>
                                                <br>
                                                <small class="text-muted">
                                                    {% if schedule.recurrence_type == 'interval' %}
                                                        Every {{ schedule.every }} {{ schedule.period }}
                                                    {% else %}
                                                        {{ schedule.minute }} {{ schedule.hour }} {{ schedule.day_of_month }} {{ schedule.month_of_year }} {{ schedule.day_of_week }}
                                                    {% endif %}
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                <span class="badge bg-{{ schedule.enabled|yesno:'success,danger' }}">
                                                    {{ schedule.enabled|yesno:'Active,Inactive' }}
                                                </span>
                                                <br>
                                                <button class="btn btn-sm btn-outline-primary mt-1" onclick="editSchedule({{ schedule.id }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger mt-1" onclick="deleteSchedule({{ schedule.id }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <p class="text-muted">No schedules configured for this model.</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sync History Tab -->
                <div class="tab-pane fade" id="history-pane" role="tabpanel">
                    <h5><i class="fas fa-history me-2"></i>Recent Sync History</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Start Time</th>
                                    <th>End Time</th>
                                    <th>Status</th>
                                    <th>Records</th>
                                    <th>Duration</th>
                                    <th>Error</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sync in sync_history %}
                                <tr>
                                    <td class="sync-time" data-time="{{ sync.start_time|date:'c' }}">{{ sync.start_time|date:"M d, Y H:i:s" }}</td>
                                    <td class="sync-time" data-time="{{ sync.end_time|date:'c' }}">{{ sync.end_time|date:"M d, Y H:i:s"|default:"-" }}</td>
                                    <td>
                                        <span class="badge bg-{% if sync.status == 'success' %}success{% elif sync.status == 'failed' %}danger{% elif sync.status == 'running' %}primary{% else %}warning{% endif %}">
                                            {{ sync.status|title }}
                                        </span>
                                    </td>
                                    <td class="records-count" data-count="{{ sync.records_processed }}">{{ sync.records_processed }}</td>
                                    <td>
                                        {% if sync.duration_seconds %}
                                            <span class="sync-duration" data-duration="{{ sync.duration_seconds }}">{{ sync.duration_seconds|floatformat:1 }}s</span>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if sync.error_message %}
                                            <span class="text-danger small">{{ sync.error_message|truncatechars:50 }}</span>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No sync history available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sync Modal -->
<div class="modal fade" id="syncModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-play me-2"></i>Sync {{ model_name|title }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="syncForm">
                    {% csrf_token %}
                    <input type="hidden" id="syncCrmName" value="{{ crm_source }}">
                    <input type="hidden" id="syncModelName" value="{{ model_name }}">
                    <div class="mb-3">
                        <label class="form-label">Sync Parameters</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="syncForce">
                            <label class="form-check-label" for="syncForce">
                                Force sync (ignore existing data)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="syncFull">
                            <label class="form-check-label" for="syncFull">
                                Full sync (all historical data)
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="syncSince" class="form-label">Since Date (optional)</label>
                        <input type="date" class="form-control" id="syncSince">
                        <div class="form-text">Only sync data modified after this date</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="executeSync()">
                    <i class="fas fa-play me-1"></i>Start Sync
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Schedule Modal -->
<div class="modal fade" id="editScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Edit Schedule
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editScheduleForm">
                    {% csrf_token %}
                    <input type="hidden" id="editScheduleId">
                    <input type="hidden" id="editCrmSource">
                    <input type="hidden" id="editModelName">
                    
                    <div class="mb-3">
                        <label for="editScheduleName" class="form-label">Schedule Name</label>
                        <input type="text" class="form-control" id="editScheduleName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editScheduleMode" class="form-label">Mode</label>
                        <select class="form-select" id="editScheduleMode" required>
                            <option value="delta">Delta - Import since last import</option>
                            <option value="full">Full - Delete everything and import again</option>
                            <option value="force7">Force7 - Import last 7 days with --force flag</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editRecurrenceType" class="form-label">Recurrence Type</label>
                        <select class="form-select" id="editRecurrenceType" onchange="toggleEditRecurrenceFields()">
                            <option value="interval">Interval (every X minutes/hours/days)</option>
                            <option value="crontab">Crontab (specific times)</option>
                        </select>
                    </div>
                    
                    <!-- Interval fields -->
                    <div id="editIntervalFields">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="editEvery" class="form-label">Every</label>
                                <input type="number" class="form-control" id="editEvery" min="1">
                            </div>
                            <div class="col-md-6">
                                <label for="editPeriod" class="form-label">Period</label>
                                <select class="form-select" id="editPeriod">
                                    <option value="minutes">Minutes</option>
                                    <option value="hours">Hours</option>
                                    <option value="days">Days</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Crontab fields -->
                    <div id="editCrontabFields" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="editMinute" class="form-label">Minute (0-59)</label>
                                <input type="text" class="form-control" id="editMinute" placeholder="*">
                            </div>
                            <div class="col-md-6">
                                <label for="editHour" class="form-label">Hour (0-23)</label>
                                <input type="text" class="form-control" id="editHour" placeholder="*">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label for="editDayOfWeek" class="form-label">Day of Week (0-6)</label>
                                <input type="text" class="form-control" id="editDayOfWeek" placeholder="*">
                            </div>
                            <div class="col-md-6">
                                <label for="editDayOfMonth" class="form-label">Day of Month (1-31)</label>
                                <input type="text" class="form-control" id="editDayOfMonth" placeholder="*">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="editStartAt" class="form-label">Start At (optional)</label>
                            <input type="datetime-local" class="form-control" id="editStartAt">
                        </div>
                        <div class="col-md-6">
                            <label for="editEndAt" class="form-label">End At (optional)</label>
                            <input type="datetime-local" class="form-control" id="editEndAt">
                        </div>
                    </div>
                    
                    <div class="mb-3 mt-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editEnabled">
                            <label class="form-check-label" for="editEnabled">
                                Enabled
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveScheduleEdit()">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentCrm = '{{ crm_source }}';
let currentModel = '{{ model_name }}';
let currentPage = 1;
let totalPages = 1;
let modelMetadata = null;

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadModelMetadata();
    loadTableData();
    
    // Set up search input debouncing
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(applyFilters, 500);
    });
});

function loadModelMetadata() {
    fetch(`/ingestion/crm-dashboard/api/crms/${currentCrm}/models/${currentModel}/`)
        .then(response => response.json())
        .then(data => {
            if (data && data.success) {
                modelMetadata = data.metadata;
                updateMetrics(data);
                updateModelDescription(data.metadata);
            } else {
                showError('Failed to load metadata' + (data && (data.message || data.error) ? (': ' + (data.message || data.error)) : ''));
            }
        })
        .catch(error => {
            console.error('Error loading metadata:', error);
        });
}

function loadTableData(page = 1) {
    showTableLoading();
    
    const params = new URLSearchParams({
        page: page,
        per_page: document.getElementById('pageSizeSelect').value,
        search: document.getElementById('searchInput').value,
        order_by: document.getElementById('sortSelect').value
    });

    fetch(`/ingestion/crm-dashboard/api/crms/${currentCrm}/models/${currentModel}/data/?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data && data.success) {
                renderTable(data.data, modelMetadata || {});
                updatePagination(data.pagination);
                currentPage = page;
                totalPages = data.pagination.total_pages;
            } else {
                showError('Failed to load data' + (data && (data.message || data.error) ? (': ' + (data.message || data.error)) : ''));
            }
        })
        .catch(error => {
            console.error('Error loading data:', error);
            showError('Failed to load data');
        })
        .finally(() => {
            hideTableLoading();
        });
}

function updateMetrics(detail) {
    const stats = (detail.statistics && detail.statistics.statistics) ? detail.statistics.statistics : {};
    document.getElementById('totalRecords').textContent = formatNumber(stats.total_records);
    const last = detail.sync_info && (detail.sync_info.end_time || detail.sync_info.start_time) ? (detail.sync_info.end_time || detail.sync_info.start_time) : null;
    document.getElementById('lastSyncDate').textContent = formatDateShort(last);
    
    // Format duration properly
    const duration = detail.sync_info && detail.sync_info.duration ? detail.sync_info.duration : null;
    if (duration && !isNaN(duration)) {
        // If duration is a number (seconds), format it
        document.getElementById('syncDuration').textContent = formatDuration(parseFloat(duration));
    } else if (duration) {
        // If duration is already formatted as a string, use it as is
        document.getElementById('syncDuration').textContent = duration;
    } else {
        document.getElementById('syncDuration').textContent = 'N/A';
    }
    
    const statusElement = document.getElementById('syncStatus');
    const status = detail.sync_info && detail.sync_info.status ? detail.sync_info.status : 'never';
    statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
    statusElement.className = `metric-number ${getStatusColor(status)}`;
}

function updateModelDescription(metadata) {
    const description = metadata.description || `${currentModel} data model from ${currentCrm}`;
    document.getElementById('modelDescription').textContent = description;
}

function renderTable(data, metadata) {
    const tableContainer = document.getElementById('tableContainer');
    const emptyState = document.getElementById('emptyState');
    const recordsInfo = document.getElementById('recordsInfo');
    
    if (!data || data.length === 0) {
        tableContainer.style.display = 'none';
        emptyState.style.display = 'block';
        recordsInfo.textContent = '(0 records)';
        return;
    }
    
    // Update records info
    recordsInfo.textContent = `(${data.length} records)`;
    
    // Build table header
    const tableHead = document.getElementById('tableHead');
    const fields = (metadata.fields ? (metadata.fields.map(f => f.name)) : Object.keys(data[0] || {}));
    
    tableHead.innerHTML = `
        <tr>
            ${fields.map(field => `<th>${formatFieldName(field)}</th>`).join('')}
        </tr>
    `;
    
    // Build table body
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = data.map(row => `
        <tr>
            ${fields.map(field => `<td>${formatCellValue(row[field], field)}</td>`).join('')}
        </tr>
    `).join('');
    
    emptyState.style.display = 'none';
    tableContainer.style.display = 'block';
}

function updatePagination(pagination) {
    const container = document.getElementById('paginationContainer');
    const info = document.getElementById('paginationInfo');
    const list = document.getElementById('paginationList');
    
    if (!pagination || pagination.total_pages <= 1) {
        container.style.display = 'none';
        return;
    }
    
    // Update pagination info
    const start = pagination.start_index || ((pagination.current_page - 1) * pagination.items_per_page + 1);
    const end = pagination.end_index || Math.min(start + pagination.items_per_page - 1, pagination.total_items);
    info.textContent = `Showing ${start}-${end} of ${pagination.total_items} records`;
    
    // Build pagination links
    let links = '';
    
    // Previous button
    if (pagination.has_previous) {
        links += `<li class="page-item">
            <a class="page-link" href="#" onclick="loadTableData(${pagination.current_page - 1})">Previous</a>
        </li>`;
    }
    
    // Page numbers
    const startPage = Math.max(1, pagination.current_page - 2);
    const endPage = Math.min(pagination.total_pages, pagination.current_page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === pagination.current_page ? 'active' : '';
        links += `<li class="page-item ${activeClass}">
            <a class="page-link" href="#" onclick="loadTableData(${i})">${i}</a>
        </li>`;
    }
    
    // Next button
    if (pagination.has_next) {
        links += `<li class="page-item">
            <a class="page-link" href="#" onclick="loadTableData(${pagination.current_page + 1})">Next</a>
        </li>`;
    }
    
    list.innerHTML = links;
    container.style.display = 'flex';
}

function applyFilters() {
    currentPage = 1;
    loadTableData(1);
}

function refreshData() {
    loadModelMetadata();
    loadTableData(currentPage);
}

function showSyncModal() {
    new bootstrap.Modal(document.getElementById('syncModal')).show();
}

// Global flag to prevent multiple sync executions
let syncInProgress = false;

function executeSync() {
    // Check to prevent multiple sync executions
    if (syncInProgress) {
        return;
    }

    const syncButton = document.querySelector('#syncModal .btn-primary');
    
    // Prevent double submissions by checking if already in progress
    if (syncButton.disabled) {
        return;
    }
    
    // Set global flag and button state
    syncInProgress = true;
    
    const crm = document.getElementById('syncCrmName').value;
    const model = document.getElementById('syncModelName').value;
    const force = document.getElementById('syncForce').checked;
    const full = document.getElementById('syncFull').checked;
    const since = document.getElementById('syncSince').value;
    
    const params = {};
    if (force) params.force = true;
    if (full) params.full = true;
    if (since) params.since = since;
    
    const payload = {
        crm_source: crm,
        sync_type: modelNameToSyncType(model),
        parameters: params
    };

    // Disable button and show loading state
    syncButton.disabled = true;
    const originalText = syncButton.innerHTML;
    syncButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Starting...';

    fetch('/ingestion/crm-dashboard/api/sync/execute/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Sync started successfully');
            bootstrap.Modal.getInstance(document.getElementById('syncModal')).hide();
            setTimeout(refreshData, 2000);
        } else {
            let errorMsg = 'Failed to start sync: ' + (data.error || data.message || 'Unknown error');
            if (data.duplicate_cancelled) {
                errorMsg = 'Duplicate sync prevented: ' + data.error;
            }
            showError(errorMsg);
        }
    })
    .catch(error => {
        showError('Failed to start sync: ' + error.message);
    })
    .finally(() => {
        // Re-enable button and restore original text
        syncButton.disabled = false;
        syncButton.innerHTML = originalText;
        // Clear global flag
        syncInProgress = false;
    });
}

function exportData() {
    const params = new URLSearchParams({
        search: document.getElementById('searchInput').value,
        ordering: document.getElementById('sortSelect').value,
        export: 'csv'
    });
    
    window.open(`/ingestion/crm-dashboard/api/crms/${currentCrm}/models/${currentModel}/data/?${params}`);
}

function showTableLoading() {
    document.getElementById('tableLoading').style.display = 'block';
    document.getElementById('tableContainer').style.display = 'none';
    document.getElementById('emptyState').style.display = 'none';
}

function hideTableLoading() {
    document.getElementById('tableLoading').style.display = 'none';
}

// Utility functions
function formatFieldName(field) {
    return field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function formatCellValue(value, field) {
    if (value === null || value === undefined) return '-';
    if (typeof value === 'boolean') return value ? 'Yes' : 'No';
    if (field.includes('date') || field.includes('time')) {
        try {
            return new Date(value).toLocaleString();
        } catch {
            return value;
        }
    }
    if (typeof value === 'number' && value > 1000000) {
        return value.toLocaleString();
    }
    return String(value).length > 50 ? String(value).substring(0, 50) + '...' : value;
}

function formatNumber(num) {
    if (!num && num !== 0) return '0';
    return parseInt(num).toLocaleString();
}

function formatDateShort(dateStr) {
    if (!dateStr) return 'Never';
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = Math.abs(now - date);
    const diffMinutes = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffWeeks = Math.floor(diffDays / 7);
    const diffMonths = Math.floor(diffDays / 30);
    const diffYears = Math.floor(diffDays / 365);

    if (diffMinutes < 1) {
        return 'Just now';
    }
    if (diffMinutes < 60) {
        return `${diffMinutes} minute${diffMinutes !== 1 ? 's' : ''} ago`;
    }
    if (diffHours < 24) {
        return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
    }
    if (diffDays < 7) {
        return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
    }
    if (diffWeeks < 5) {
        return `${diffWeeks} week${diffWeeks !== 1 ? 's' : ''} ago`;
    }
    if (diffMonths < 12) {
        return `${diffMonths} month${diffMonths !== 1 ? 's' : ''} ago`;
    }
    return `${diffYears} year${diffYears !== 1 ? 's' : ''} ago`;
}

function getStatusColor(status) {
    const colors = {
        'success': 'text-success',
        'error': 'text-danger',
        'running': 'text-primary',
        'never': 'text-muted',
        'never_synced': 'text-muted',
        'outdated': 'text-muted',
        'warning': 'text-warning'
    };
    return colors[status] || 'text-muted';
}

function modelNameToSyncType(modelName) {
    if (!modelName) return '';
    
    // Handle specific model mappings first
    const modelMappings = {
        'CallRail_Account': 'accounts',
        'CallRail_Call': 'calls', 
        'CallRail_Company': 'companies',
        'CallRail_FormSubmission': 'form_submissions',
        'CallRail_Tag': 'tags',
        'CallRail_TextMessage': 'text_messages',
        'CallRail_Tracker': 'trackers',
        'CallRail_User': 'users',
        // Add SalesRabbit mappings
        'SalesRabbit_Lead': 'leads',
        'SalesRabbit_User': 'users'
    };
    
    if (modelMappings[modelName]) {
        return modelMappings[modelName];
    }
    
    // Fall back to general conversion for other CRMs
    let name = modelName;
    
    // Handle specific CRM patterns first
    if (name.startsWith('CallRail_')) {
        name = name.substring(9); // Remove 'CallRail_'
    } else if (name.startsWith('Genius_')) {
        name = name.substring(7); // Remove 'Genius_'
    } else if (name.startsWith('Hubspot_') || name.startsWith('HubSpot_')) {
        name = name.substring(8); // Remove 'Hubspot_'/'HubSpot_'
    } else if (name.startsWith('Salespro_')) {
        name = name.substring(9); // Remove 'Salespro_'
    } else if (name.startsWith('SalesRabbit_')) {
        name = name.substring(12); // Remove 'SalesRabbit_' (fix case sensitivity)
    } else if (name.startsWith('Arrivy_')) {
        name = name.substring(7); // Remove 'Arrivy_'
    }
    
    name = name.toLowerCase();
    if (name.endsWith('y')) return name.slice(0, -1) + 'ies';
    if (name.endsWith('s')) return name; // already plural
    return name + 's';
}

function getCsrfToken() {
    // Try to get from form element first
    const el = document.querySelector('[name=csrfmiddlewaretoken]');
    if (el) return el.value;
    
    // Fallback to cookie method
    return getCookie('csrftoken');
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showSuccess(message) {
    alert('Success: ' + message);
}

function showError(message) {
    alert('Error: ' + message);
}

// Schedule management functions
document.addEventListener('DOMContentLoaded', function() {
    // Handle recurrence type change
    const recurrenceType = document.getElementById('{{ schedule_form.recurrence_type.id_for_label }}');
    const intervalFields = document.getElementById('intervalFields');
    const crontabFields = document.getElementById('crontabFields');
    
    function toggleScheduleFields() {
        if (recurrenceType.value === 'interval') {
            intervalFields.style.display = 'block';
            crontabFields.style.display = 'none';
        } else if (recurrenceType.value === 'crontab') {
            intervalFields.style.display = 'none';
            crontabFields.style.display = 'block';
        } else {
            intervalFields.style.display = 'none';
            crontabFields.style.display = 'none';
        }
    }
    
    recurrenceType.addEventListener('change', toggleScheduleFields);
    toggleScheduleFields(); // Initial setup
    
    // Handle schedule form submission
    document.getElementById('scheduleForm').addEventListener('submit', function(e) {
        e.preventDefault();
        createSchedule();
    });
});

function createSchedule() {
    const form = document.getElementById('scheduleForm');
    const formData = new FormData(form);
    const data = {};
    
    formData.forEach((value, key) => {
        data[key] = value;
    });
    
    fetch(`/ingestion/crm-dashboard/api/crms/${currentCrm}/models/${currentModel}/schedules/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Schedule created successfully');
            location.reload(); // Reload to show new schedule
        } else {
            showError(data.error || 'Failed to create schedule');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Failed to create schedule');
    });
}

function editSchedule(scheduleId) {
    // Get schedule details via API
    fetch(`/ingestion/crm-dashboard/api/schedules/${scheduleId}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const schedule = data.data;
            
            // Populate the edit form
            document.getElementById('editScheduleId').value = schedule.id;
            document.getElementById('editCrmSource').value = schedule.crm_source;
            document.getElementById('editModelName').value = schedule.model_name;
            document.getElementById('editScheduleName').value = schedule.name;
            document.getElementById('editScheduleMode').value = schedule.mode;
            document.getElementById('editRecurrenceType').value = schedule.recurrence_type;
            document.getElementById('editEnabled').checked = schedule.enabled;
            
            // Handle interval vs crontab fields
            if (schedule.recurrence_type === 'interval') {
                document.getElementById('editEvery').value = schedule.every || '';
                document.getElementById('editPeriod').value = schedule.period || 'minutes';
            } else {
                document.getElementById('editMinute').value = schedule.minute || '*';
                document.getElementById('editHour').value = schedule.hour || '*';
                document.getElementById('editDayOfWeek').value = schedule.day_of_week || '*';
                document.getElementById('editDayOfMonth').value = schedule.day_of_month || '*';
            }
            
            // Handle datetime fields
            if (schedule.start_at) {
                const startDate = new Date(schedule.start_at);
                document.getElementById('editStartAt').value = startDate.toISOString().slice(0, 16);
            }
            if (schedule.end_at) {
                const endDate = new Date(schedule.end_at);
                document.getElementById('editEndAt').value = endDate.toISOString().slice(0, 16);
            }
            
            // Toggle field visibility
            toggleEditRecurrenceFields();
            
            // Show the modal
            new bootstrap.Modal(document.getElementById('editScheduleModal')).show();
        } else {
            showError('Failed to load schedule details: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error loading schedule:', error);
        showError('Failed to load schedule details');
    });
}

function toggleEditRecurrenceFields() {
    const recurrenceType = document.getElementById('editRecurrenceType').value;
    const intervalFields = document.getElementById('editIntervalFields');
    const crontabFields = document.getElementById('editCrontabFields');
    
    if (recurrenceType === 'interval') {
        intervalFields.style.display = 'block';
        crontabFields.style.display = 'none';
    } else {
        intervalFields.style.display = 'none';
        crontabFields.style.display = 'block';
    }
}

function saveScheduleEdit() {
    const scheduleId = document.getElementById('editScheduleId').value;
    const recurrenceType = document.getElementById('editRecurrenceType').value;
    
    const payload = {
        crm_source: document.getElementById('editCrmSource').value,
        model_name: document.getElementById('editModelName').value,
        name: document.getElementById('editScheduleName').value,
        mode: document.getElementById('editScheduleMode').value,
        recurrence_type: recurrenceType,
        enabled: document.getElementById('editEnabled').checked,
        start_at: document.getElementById('editStartAt').value || null,
        end_at: document.getElementById('editEndAt').value || null
    };
    
    // Add recurrence-specific fields
    if (recurrenceType === 'interval') {
        payload.every = parseInt(document.getElementById('editEvery').value) || null;
        payload.period = document.getElementById('editPeriod').value;
    } else {
        payload.minute = document.getElementById('editMinute').value || '*';
        payload.hour = document.getElementById('editHour').value || '*';
        payload.day_of_week = document.getElementById('editDayOfWeek').value || '*';
        payload.day_of_month = document.getElementById('editDayOfMonth').value || '*';
        payload.month_of_year = '*';
    }
    
    fetch(`/ingestion/crm-dashboard/api/schedules/${scheduleId}/`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Schedule updated successfully');
            bootstrap.Modal.getInstance(document.getElementById('editScheduleModal')).hide();
            
            // Reload the page to show updated schedule
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showError('Failed to update schedule: ' + (data.error || data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error updating schedule:', error);
        showError('Failed to update schedule');
    });
}

function deleteSchedule(scheduleId) {
    if (confirm('Are you sure you want to delete this schedule?')) {
        fetch(`/ingestion/crm-dashboard/api/schedules/${scheduleId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('Schedule deleted successfully');
                location.reload(); // Reload to remove deleted schedule
            } else {
                showError(data.error || 'Failed to delete schedule');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Failed to delete schedule');
        });
    }
}

// Format time and duration values on page load
function formatPageValues() {
    // Format time ago values
    document.querySelectorAll('.sync-time').forEach(element => {
        const timeStr = element.getAttribute('data-time');
        if (timeStr && timeStr !== '-') {
            const date = new Date(timeStr);
            element.textContent = formatTimeAgo(date);
        }
    });
    
    // Format duration values
    document.querySelectorAll('.sync-duration').forEach(element => {
        const duration = parseFloat(element.getAttribute('data-duration'));
        if (duration) {
            element.textContent = formatDuration(duration);
        }
    });
    
    // Format record counts
    document.querySelectorAll('.records-count').forEach(element => {
        const count = parseInt(element.getAttribute('data-count'));
        if (count || count === 0) {
            element.textContent = formatRecordsCount(count);
        }
    });
}

function formatTimeAgo(date) {
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffMinutes = Math.floor(diffTime / (1000 * 60));
    const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffMinutes < 1) {
        return 'Just now';
    } else if (diffMinutes < 60) {
        return `${diffMinutes} minute${diffMinutes !== 1 ? 's' : ''} ago`;
    } else if (diffHours < 24) {
        return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
    } else if (diffDays < 7) {
        return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
    } else {
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
}

function formatDuration(seconds) {
    if (!seconds || seconds <= 0) return '0s';
    
    const totalSeconds = Math.floor(seconds);
    const days = Math.floor(totalSeconds / 86400);
    const hours = Math.floor((totalSeconds % 86400) / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const secs = totalSeconds % 60;
    
    const parts = [];
    
    if (days > 0) {
        parts.push(`${days}d`);
        if (hours > 0) {
            parts.push(`${hours}h`);
        }
        if (minutes > 0 && days === 0) {
            parts.push(`${minutes}m`);
        }
    } else if (hours > 0) {
        parts.push(`${hours}h`);
        if (minutes > 0) {
            parts.push(`${minutes}m`);
        }
    } else if (minutes > 0) {
        parts.push(`${minutes}m`);
        if (secs > 0) {
            parts.push(`${secs}s`);
        }
    } else {
        parts.push(`${secs}s`);
    }
    
    return parts.join(' ');
}

function formatRecordsCount(count) {
    if (!count && count !== 0) return '0';
    
    const num = parseInt(count);
    
    if (num < 1000) {
        return num.toString();
    } else if (num < 1000000) {
        return `${(num/1000).toFixed(1)}K`;
    } else if (num < 1000000000) {
        return `${(num/1000000).toFixed(1)}M`;
    } else {
        return `${(num/1000000000).toFixed(1)}B`;
    }
}

// Initialize formatting when page loads
document.addEventListener('DOMContentLoaded', formatPageValues);
</script>
{% endblock %}
