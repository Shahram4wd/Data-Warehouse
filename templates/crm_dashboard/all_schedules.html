{% extends 'crm_dashboard/base.html' %}
{% load static %}

{% block title %}All Schedules - CRM Dashboard{% endblock %}

{% block extra_css %}
<style>
    .schedule-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    .metric-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border: none;
        transition: transform 0.2s;
    }
    .metric-card:hover {
        transform: translateY(-2px);
    }
    .metric-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    .metric-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .schedule-table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .table-header {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        padding: 1rem 1.5rem;
    }
    .table th {
        border: none;
        font-weight: 600;
        color: #495057;
        background: #f8f9fa;
        cursor: pointer;
        user-select: none;
    }
    .table th:hover {
        background: #e9ecef;
    }
    .table td {
        border: none;
        border-bottom: 1px solid #f1f3f4;
        vertical-align: middle;
    }
    .filter-controls {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .breadcrumb {
        background: none;
        padding: 0;
        margin-bottom: 1.5rem;
    }
    .breadcrumb-item + .breadcrumb-item::before {
        content: "â€º";
        color: #6c757d;
    }
    .status-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .sort-icon {
        margin-left: 0.5rem;
        opacity: 0.5;
    }
    .sort-icon.active {
        opacity: 1;
    }
</style>
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'ingestion:crm_dashboard:crm_dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item active" aria-current="page">All Schedules</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="schedule-header">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="mb-0">
                    <i class="fas fa-calendar-alt me-3"></i>All Schedules Management
                </h1>
                <p class="mb-0 mt-2 opacity-75">Manage all data ingestion schedules across all CRM sources</p>
            </div>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-lg-6">
            <div class="metric-card">
                <div class="metric-number text-primary">{{ total_schedules }}</div>
                <div class="metric-label">Total Schedules</div>
            </div>
        </div>
        <div class="col-xl-3 col-lg-6">
            <div class="metric-card">
                <div class="metric-number text-success">{{ active_schedules }}</div>
                <div class="metric-label">Active Schedules</div>
            </div>
        </div>
        <div class="col-xl-3 col-lg-6">
            <div class="metric-card">
                <div class="metric-number text-info">{{ crm_sources|length }}</div>
                <div class="metric-label">CRM Sources</div>
            </div>
        </div>
        <div class="col-xl-3 col-lg-6">
            <div class="metric-card">
                <div class="metric-number text-warning">{{ modes|length }}</div>
                <div class="metric-label">Sync Modes</div>
            </div>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="filter-controls">
        <div class="row align-items-end">
            <div class="col-md-3">
                <label for="crmFilter" class="form-label">Filter by CRM Source</label>
                <select class="form-select" id="crmFilter">
                    <option value="">All CRM Sources</option>
                    {% for crm in crm_sources %}
                    <option value="{{ crm }}">{{ crm|title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="modeFilter" class="form-label">Filter by Mode</label>
                <select class="form-select" id="modeFilter">
                    <option value="">All Modes</option>
                    {% for mode in modes %}
                    <option value="{{ mode }}">{{ mode|title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="statusFilter" class="form-label">Filter by Status</label>
                <select class="form-select" id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary w-100" onclick="applyFilters()">
                    <i class="fas fa-filter me-1"></i>Apply Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Schedules Table -->
    <div class="schedule-table-container">
        <div class="table-header">
            <div class="row align-items-center">
                <div class="col">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>All Schedules
                        <span id="scheduleCount" class="text-muted small ms-2">({{ total_schedules }} total)</span>
                    </h5>
                </div>
                <div class="col-auto">
                    <button class="btn btn-outline-success btn-sm" onclick="refreshSchedules()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="schedulesTable">
                <thead>
                    <tr>
                        <th onclick="sortTable('name')">
                            Name
                            <i class="fas fa-sort sort-icon" id="sort-name"></i>
                        </th>
                        <th onclick="sortTable('crm_source')">
                            CRM Source
                            <i class="fas fa-sort sort-icon" id="sort-crm_source"></i>
                        </th>
                        <th onclick="sortTable('model_name')">
                            Model
                            <i class="fas fa-sort sort-icon" id="sort-model_name"></i>
                        </th>
                        <th onclick="sortTable('mode')">
                            Mode
                            <i class="fas fa-sort sort-icon" id="sort-mode"></i>
                        </th>
                        <th onclick="sortTable('recurrence_type')">
                            Recurrence
                            <i class="fas fa-sort sort-icon" id="sort-recurrence_type"></i>
                        </th>
                        <th onclick="sortTable('enabled')">
                            Status
                            <i class="fas fa-sort sort-icon" id="sort-enabled"></i>
                        </th>
                        <th>Last Run</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="schedulesTableBody">
                    <!-- Data will be loaded via JavaScript -->
                </tbody>
            </table>
        </div>
        <div class="p-3" id="loadingIndicator">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 mb-0 text-muted">Loading schedules...</p>
            </div>
        </div>
    </div>
</div>

<!-- Edit Schedule Modal -->
<div class="modal fade" id="editScheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Edit Schedule
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="editScheduleForm">
                <!-- Form will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSchedule()">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allSchedules = [];
let currentSort = { field: 'name', direction: 'asc' };
let currentFilters = { crm_source: '', mode: '', enabled: '' };

// Load schedules on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSchedules();
});

function loadSchedules() {
    const loadingIndicator = document.getElementById('loadingIndicator');
    loadingIndicator.style.display = 'block';
    
    fetch('/ingestion/crm-dashboard/api/schedules/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allSchedules = data.data;
                renderSchedules();
                updateScheduleCount(data.count);
            } else {
                showError(data.error || 'Failed to load schedules');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Failed to load schedules');
        })
        .finally(() => {
            loadingIndicator.style.display = 'none';
        });
}

function renderSchedules() {
    let filteredSchedules = filterSchedules(allSchedules);
    filteredSchedules = sortSchedules(filteredSchedules);
    
    const tbody = document.getElementById('schedulesTableBody');
    tbody.innerHTML = '';
    
    if (filteredSchedules.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="fas fa-calendar-times fa-2x mb-2"></i><br>
                    No schedules found matching the current filters
                </td>
            </tr>
        `;
        return;
    }
    
    filteredSchedules.forEach(schedule => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <strong>${escapeHtml(schedule.name)}</strong>
            </td>
            <td>
                <span class="badge bg-primary">${escapeHtml(schedule.crm_source.toUpperCase())}</span>
            </td>
            <td>${escapeHtml(schedule.model_name)}</td>
            <td>
                <span class="badge bg-${getModeColor(schedule.mode)}">${escapeHtml(schedule.mode_display)}</span>
            </td>
            <td>
                ${getRecurrenceDisplay(schedule)}
            </td>
            <td>
                <span class="status-badge bg-${schedule.enabled ? 'success' : 'danger'}">
                    ${schedule.enabled ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                ${getLastRunDisplay(schedule.last_run)}
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editSchedule(${schedule.id})" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteSchedule(${schedule.id}, '${escapeHtml(schedule.name)}')" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    updateScheduleCount(filteredSchedules.length);
}

function filterSchedules(schedules) {
    return schedules.filter(schedule => {
        if (currentFilters.crm_source && schedule.crm_source !== currentFilters.crm_source) {
            return false;
        }
        if (currentFilters.mode && schedule.mode !== currentFilters.mode) {
            return false;
        }
        if (currentFilters.enabled !== '' && schedule.enabled.toString() !== currentFilters.enabled) {
            return false;
        }
        return true;
    });
}

function sortSchedules(schedules) {
    return schedules.sort((a, b) => {
        let valueA = a[currentSort.field];
        let valueB = b[currentSort.field];
        
        // Handle null/undefined values
        if (valueA == null) valueA = '';
        if (valueB == null) valueB = '';
        
        // Convert to strings for comparison
        valueA = valueA.toString().toLowerCase();
        valueB = valueB.toString().toLowerCase();
        
        if (currentSort.direction === 'asc') {
            return valueA.localeCompare(valueB);
        } else {
            return valueB.localeCompare(valueA);
        }
    });
}

function sortTable(field) {
    if (currentSort.field === field) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.field = field;
        currentSort.direction = 'asc';
    }
    
    // Update sort icons
    document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.className = 'fas fa-sort sort-icon';
    });
    
    const activeIcon = document.getElementById(`sort-${field}`);
    activeIcon.className = `fas fa-sort-${currentSort.direction === 'asc' ? 'up' : 'down'} sort-icon active`;
    
    renderSchedules();
}

function applyFilters() {
    currentFilters.crm_source = document.getElementById('crmFilter').value;
    currentFilters.mode = document.getElementById('modeFilter').value;
    currentFilters.enabled = document.getElementById('statusFilter').value;
    
    renderSchedules();
}

function refreshSchedules() {
    loadSchedules();
}

function updateScheduleCount(count) {
    document.getElementById('scheduleCount').textContent = `(${count} ${count === 1 ? 'schedule' : 'schedules'})`;
}

function getModeColor(mode) {
    switch (mode) {
        case 'delta': return 'info';
        case 'full': return 'warning';
        case 'force7': return 'danger';
        default: return 'secondary';
    }
}

function getRecurrenceDisplay(schedule) {
    if (schedule.recurrence_type === 'interval') {
        return `Every ${schedule.every} ${schedule.period}`;
    } else if (schedule.recurrence_type === 'crontab') {
        return `<code>${schedule.cron_expression}</code>`;
    }
    return schedule.recurrence_type;
}

function getLastRunDisplay(lastRun) {
    if (!lastRun) {
        return '<span class="text-muted">Never</span>';
    }
    
    const date = new Date(lastRun.start_time);
    const statusClass = lastRun.status === 'success' ? 'success' : 
                       lastRun.status === 'failed' ? 'danger' : 'warning';
    
    return `
        <div>
            <small>${date.toLocaleDateString()} ${date.toLocaleTimeString()}</small><br>
            <span class="badge bg-${statusClass}">${lastRun.status}</span>
            ${lastRun.records_processed ? `<br><small>${lastRun.records_processed} records</small>` : ''}
        </div>
    `;
}

function editSchedule(scheduleId) {
    // Load schedule details and show edit modal
    fetch(`/ingestion/crm-dashboard/api/schedules/${scheduleId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showEditScheduleModal(data.data);
            } else {
                showError(data.error || 'Failed to load schedule details');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Failed to load schedule details');
        });
}

function showEditScheduleModal(schedule) {
    // TODO: Generate edit form dynamically
    // For now, redirect to the model detail page
    window.location.href = `/ingestion/crm-dashboard/${schedule.crm_source}/${schedule.model_name}/`;
}

function deleteSchedule(scheduleId, scheduleName) {
    if (confirm(`Are you sure you want to delete the schedule "${scheduleName}"?`)) {
        fetch(`/ingestion/crm-dashboard/api/schedules/${scheduleId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('Schedule deleted successfully');
                loadSchedules(); // Reload the list
            } else {
                showError(data.error || 'Failed to delete schedule');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Failed to delete schedule');
        });
    }
}

function saveSchedule() {
    // TODO: Implement save functionality
    showError('Save functionality will be implemented in a future update');
}

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCsrfToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showSuccess(message) {
    alert('Success: ' + message);
}

function showError(message) {
    alert('Error: ' + message);
}
</script>
{% endblock %}
